<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Optimizer & LaTeX Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .input-area, .output-area {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        textarea, #latex-editor {
            resize: none;
            transition: border-color 0.2s;
        }
        #latex-editor {
            min-height: 400px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap; /* Preserve formatting */
            word-wrap: break-word;
        }
        #pdf-preview-iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700">Gemini Resume Generator</h1>
            <p class="text-lg text-gray-500 mt-2">Optimize your resume using AI and generate professional LaTeX code.</p>
        </header>

        <!-- Input Section -->
        <div class="input-area bg-white p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Provide Your Inputs</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="current-resume" class="block text-sm font-medium text-gray-700 mb-2">Current Unoptimized Resume Text</label>
                    <textarea id="current-resume" rows="12" placeholder="Paste your current resume text here. The AI will optimize this content."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label for="job-description" class="block text-sm font-medium text-gray-700 mb-2">Target Job Description Text</label>
                    <textarea id="job-description" rows="12" placeholder="Paste the job description you are applying for. The AI will use this for keyword matching."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
            </div>

            <button id="generate-button"
                    class="mt-6 w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50">
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Optimize & Generate LaTeX
            </button>
            <div id="status-message" class="mt-4 text-center text-sm font-medium"></div>
        </div>

        <!-- Output Section -->
        <div class="output-area bg-white p-6 rounded-xl grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: LaTeX Editor -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                    2. Edit & Review LaTeX Code
                </h2>
                <div class="relative">
                    <textarea id="latex-editor" placeholder="Generated LaTeX code will appear here..."
                        class="w-full p-4 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-gray-50 min-h-[400px]"></textarea>
                    
                    <div class="flex space-x-3 mt-3">
                        <button id="compile-button" disabled
                                class="flex-1 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-300 disabled:opacity-50">
                            Compile & Preview PDF
                        </button>
                        <button id="download-button" disabled
                                class="flex-1 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-300 disabled:opacity-50">
                            Download .tex File
                        </button>
                    </div>
                </div>
                <p class="mt-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                    <span class="font-bold">Hint:</span> Use the "Compile" button to see a real-time PDF preview in your browser!
                </p>
            </div>

            <!-- Right Column: PDF Preview -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">3. Compiled PDF Preview</h2>
                <iframe id="pdf-preview-iframe" title="Compiled Resume Preview"></iframe>
                <div id="pdf-loading-message" class="text-center text-gray-500 mt-2">
                    In-browser PDF compilation is disabled. Download the .tex file and use an external service like Overleaf.
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // API Configuration
        const MODEL_NAME = 'gemini-2.5-flash-preview-05-20';
        const apiKey = ""; // Leave as-is, canvas will provide it at runtime.

        // DOM Elements
        const resumeInput = document.getElementById('current-resume');
        const jobDescriptionInput = document.getElementById('job-description');
        const generateButton = document.getElementById('generate-button');
        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('status-message');
        const latexEditor = document.getElementById('latex-editor');
        const downloadButton = document.getElementById('download-button');
        const compileButton = document.getElementById('compile-button');
        const pdfIframe = document.getElementById('pdf-preview-iframe');
        const pdfLoadingMessage = document.getElementById('pdf-loading-message');

        /**
         * Generic LLM API call function with exponential backoff.
         * @param {string} userPrompt - The main query text.
         * @param {string} systemPrompt - The instruction for the model's persona.
         * @param {number} retries - Current retry count.
         */
        async function callGeminiApi(userPrompt, systemPrompt, retries = 0) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                // Use Google Search grounding for best resume practices and industry context
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retries < 5) {
                    const delay = Math.pow(2, retries) * 1000;
                    console.log(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiApi(userPrompt, systemPrompt, retries + 1);
                }

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                     // Check if a block reason is present
                    const blockReason = result.candidates?.[0]?.finishReason;
                    if (blockReason === 'SAFETY') {
                        throw new Error('Response blocked due to safety settings. Please adjust your input.');
                    }
                    throw new Error('API response was empty or malformed.');
                }
                
                return text;

            } catch (error) {
                console.error("Gemini API Error:", error);
                throw new Error(`Failed to generate resume: ${error.message}`);
            }
        }

        /**
         * Main Optimization Logic: Calls the LLM to generate LaTeX code.
         */
        async function optimizeAndGenerate() {
            const resumeText = resumeInput.value.trim();
            const jobDescription = jobDescriptionInput.value.trim();

            if (!resumeText || !jobDescription) {
                statusMessage.textContent = 'Please paste both your current resume and the job description.';
                statusMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            spinner.classList.remove('hidden');
            statusMessage.textContent = 'Optimizing content and generating LaTeX... This may take a moment.';
            statusMessage.className = 'mt-4 text-center text-sm font-medium text-indigo-600';
            latexEditor.value = '';
            downloadButton.disabled = true;
            compileButton.disabled = true; // Always disabled now

            // --- LLM Prompts ---
            const systemPrompt = `You are an expert resume optimizer and LaTeX code generator. Your task is to analyze the provided unoptimized resume and the job description, then generate the full, professional, and optimized LaTeX code for a resume.

1.  **Optimization:** Identify key skills and requirements from the Job Description. Rewrite the resume's experience bullet points to strongly align with job keywords, using powerful action verbs and quantifying achievements (metrics, results) where possible. Maintain a clean, professional structure (Contact, Summary/Objective, Experience, Education, Skills).
2.  **LaTeX Output:** The final output MUST be ONLY the raw, complete, and compilable LaTeX code for a single document.
3.  **Formatting:** Use a standard, simple, modern resume template based on the 'article' document class or a common package like 'moderncv' (if possible, prefer simple document structure to ensure maximum compatibility). Do NOT include any explanatory text, markdown code wrappers (like \`\`\`latex), or comments outside the LaTeX environment (e.g., % comment). The first character of your response must be '\' (backslash) to start the LaTeX document.`;

            const userPrompt = `Target Job Description:\n---\n${jobDescription}\n---\nUnoptimized Resume Text:\n---\n${resumeText}`;
            // --- End LLM Prompts ---

            try {
                const generatedLatex = await callGeminiApi(userPrompt, systemPrompt);

                // UI State: Success
                latexEditor.value = generatedLatex;
                downloadButton.disabled = false;
                statusMessage.textContent = 'Optimization complete! Review and edit the LaTeX code below. Use the Download button to get your .tex file.';
                statusMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';

            } catch (error) {
                // UI State: Error
                latexEditor.value = `Error generating LaTeX: ${error.message}`;
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            } finally {
                // UI State: Finish
                generateButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        /**
         * Placeholder for the compile function. In-browser compilation is unstable.
         */
        async function compileLatex() {
             pdfLoadingMessage.textContent = '❌ In-browser PDF compilation is disabled. Please click "Download .tex File" and compile your resume using an external service (like Overleaf or a local TeX distribution) for PDF generation.';
             pdfLoadingMessage.className = 'mt-2 text-center text-sm font-medium text-red-600';
        }


        /**
         * Handles downloading the generated LaTeX code as a .tex file.
         */
        function downloadLatex() {
            const latexContent = latexEditor.value;
            if (!latexContent) return;

            const blob = new Blob([latexContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'optimized_resume.tex';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initial content and setup on load
        window.onload = () => {
             // Add sample content for easier first run
            resumeInput.value = `John Doe
            Email: john.doe@email.com | Phone: (555) 123-4567 | LinkedIn: linkedin.com/in/johndoe

            Experience
            Software Developer at TechCorp (2020 - Present)
            Built applications. Worked on fixing bugs. Used Python and databases.

            Education
            BS in Computer Science, State University (2016 - 2020)

            Skills
            Python, SQL, JavaScript, Teamwork, Problem-Solving`;

            jobDescriptionInput.value = `We are seeking a highly motivated Senior Software Engineer to join our core product team. The ideal candidate will have 3+ years of experience with Python, especially in developing and optimizing high-throughput data processing pipelines. Must be proficient in modern cloud-based data warehousing (e.g., BigQuery, Snowflake) and possess strong communication skills to present findings to non-technical stakeholders. Experience leading small development projects is a plus.`;

            // Permanently disable the compile button and update the message
            compileButton.disabled = true;
            pdfLoadingMessage.textContent = '❌ In-browser PDF compilation is disabled. Download the .tex file and use an external service like Overleaf.';
        }
        
        // Event Listeners
        generateButton.addEventListener('click', optimizeAndGenerate);
        downloadButton.addEventListener('click', downloadLatex);
        compileButton.addEventListener('click', compileLatex);
    </script>
</body>
</html>
